<html prefix="og: http://ogp.me/ns#">

<head>

  <meta charset="utf-8">
  <title>novon</title>
  <meta name="description" content="novon - decentralised streaming platform">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--  Essential META Tags -->
  <meta property="og:title" content="novon">
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://novon.tv/images/card.png">
  <meta property="og:url" content="https://novon.tv">
  <meta name="twitter:card" content="summary_large_image">

  <!--  Non-Essential, But Recommended -->
  <meta property="og:description" content="decentralised streaming platform">
  <meta property="og:site_name" content="novon">
  <meta name="twitter:image:alt" content="reclaim the ownership of your broadcast">

  <!--  Non-Essential, But Required for Analytics -->
  <meta property="fb:app_id" content="novon" />
  <meta name="twitter:site" content="@novon">



  <!-- FONT
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">


  <!-- CSS
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="./lib/video-js.css" />
  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/skeleton.css">
  <link rel="stylesheet" href="./css/streaming.css">

  <!-- Favicon
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/svg" href="images/favicon.svg">

</head>

<body>

  <script src="./lib/mux.min.js"></script>
  <script src="./lib/nkn.js"></script>
  <script src="./lib/video.min.js"></script>
  <script src="./lib/zxcvbn.min.js"></script>
  <script src="./lib/purify.min.js"></script>
  <script src="./lib/marked.umd.min.js"></script>

  <script src="./js/app.js"></script>
  <script src="./js/wallet-manager.js"></script>

  <div class="navbar-spacer"></div>
  <nav class="navbar">
    <div class="container">
      <ul class="navbar-list">

        <li class="navbar-item"><img class="navbar-link" src="./images/favicon.svg" style="margin-top: 7px; width: 25px;"></li>
        <li class="navbar-item"><a id="dashboardButton" class="navbar-link">Dashboard</a></li>
        <li class="navbar-item"><a href="https://github.com/MutsiMutsi/go-novon/" target="_blank" class="navbar-link">How to stream</a></li>
      </ul>
    </div>
  </nav>

  <div class="content-container" style="width: calc(100% - 320px); float: left;">
    <div id="previewContainer" class="container stream-preview-container">
      <div class="stream-preview stream-preview-placeholder">
        <a><img id="thumbnail" class="stream-preview-image"></a>
        <h6 style="margin-bottom: 0.5rem;">Live streams will show up here...</h6>
      </div>
    </div>
    <div class="stream-container">
      <video id='streamPlayer' class="video-js" controls autoplay data-setup='{"fill": true}'></video>
      <div>
        <div id="streamFooter" style="float:left; padding-left: 10px; padding-top: 5px;"></div>
        <div style="float: right; position: relative;top: 5px;">
          <svg style="scale:0.75;" xmlns=" http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dcdcdc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg><span id="viewCount" style="position: relative; top: -6px; margin-left:5px; margin-right: 10px;">-</span>
        </div>
      </div>
      <div id="panelContainer">
      </div>
    </div>
    <div id="chatbox" class="chat-container">
      <a class="donate-button" style="display: none;">
        <svg class="donate-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-hexagon">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
      </a>
      <div contenteditable="false" type="text" id="chat-input" autocomplete="off">Join a stream to chat</div>
      <div class="progress-line"></div>

      <div class="donate-popup">
        <div style="padding: 1rem;">
          <h6 style="text-align: center;">donate nkn | <a id="depositButton">deposit nkn</a><br>
            <span id="feeWarningText" style="font-size:12px">a 0.1 nkn network transaction fee is incurred for fast confirmation and fair-use of the nkn network node operators.</span>
            <span id="showWalletAddress" style="font-size:12px; display: none;"></span>
          </h6>
          <div class="row" style="text-align: center;">
            <div class="six columns">
              Your balance:
              <h6 class="wallet-balance">loading balance</h6>
            </div>
            <div class="six columns">
              Your donation:
              <h6 class="donate-amount">0</h6>
            </div>
          </div>
          <div class="row" style="text-align: center;">
            <div class="two columns"><a id="donateSend1" class="donate-send-button">1</a></div>
            <div class="two columns"><a id="donateSend2" class="donate-send-button">2</a></div>
            <div class="two columns"><a id="donateSend5" class="donate-send-button">5</a></div>
            <div class="two columns"><a id="donateSend10" class="donate-send-button">10</a></div>
            <div class="two columns"><a id="donateSend25" class="donate-send-button">25</a></div>
            <div class="two columns"><a id="donateSend100" class="donate-send-button">100</a></div>
          </div>
          <h6 class="error-message">error message</h6>
        </div>
      </div>
      <div id="messagesBox">
      </div>
    </div>
    <div id="collapse-btn">
      <img src="./svg/chevron-left.svg">
    </div>

    <div id="blackoutPanel" style="position: fixed; top: 0px; left: 0px; bottom: 0px; right: 0px; background-color: #000000cc;"></div>

    <div class="popup" id="connection-indicator" style="display: none;">
      <span id="connection-label">Connecting to the NKN network</span>
      <br>
      <span id="subclients-connected">initiating...</span>
    </div>

    <div class="popup" id="login-popup">
      <div id="newUserLogin">
        <h6>Welcome to novon!</h6>
        <button id="guestButton">Guest</button>
        <button id="joinButton">Join</button>
      </div>
      <div id="joinUserLogin" style="display: none;">
        <h6>Give us a strong password!</h6>
        <span id="passwordSuggestion"></span>
        <input style="width:100%" type="password" placeholder="enter your password" id="joinPasswordInput">
        <input style="width:100%" type="password" placeholder="confirm your password" id="confirmJoinPasswordInput">
        <span style="font-size: 12px;">Keep both the backup and password safe since this is a decentralised service.<br>There are no servers that can help you recover!</span>
        <br>
        <br>
        <button id="downloadWallet" disabled>Download Backup</button>
      </div>
      <div id="returningUserLogin">
        <h6>Welcome back to novon!</h6>
        <input class="u-full-width" type="password" placeholder="enter your password" id="walletPasswordInput">
        <button id="authButton">Authenticate</button>
        <br>
        <a id="proceedAsGuestButton" style="font-size: 12px;">(or proceed as guest)</a>
      </div>

    </div>
  </div>

  <script>
    class Semaphore {
      constructor(initialPermits = 1) {
        this.permits = initialPermits;
        this.queue = [];
      }

      async acquire() {
        return new Promise((resolve) => {
          if (this.permits > 0) {
            this.permits--;
            resolve();
          } else {
            this.queue.push(resolve);
          }
        });
      }

      release() {
        if (this.queue.length > 0) {
          const resolve = this.queue.shift();
          resolve();
        } else {
          this.permits++;
        }
      }
    }

    if (WalletManager.IsExisting()) {
      document.getElementById("newUserLogin").style.display = 'none';
      document.getElementById("authButton").onclick = () => {
        try {
          const wallet = WalletManager.OpenExisting(document.getElementById("walletPasswordInput").value);
          new streamApp.initApp(wallet);
        } catch (er) {
          alert(er.message)
        }
      }
    } else {
      document.getElementById("returningUserLogin").style.display = 'none';
    }

    document.getElementById("guestButton").onclick = () => {
      new streamApp.initApp(null);
    };
    document.getElementById("proceedAsGuestButton").onclick = () => {
      new streamApp.initApp(null);
    };

    document.getElementById("joinButton").onclick = () => {

      document.getElementById("newUserLogin").style.display = "none";
      document.getElementById("joinUserLogin").style.display = "block";

      var passwordScore = 0;
      document.getElementById("passwordSuggestion").textContent = zxcvbn("").feedback.suggestions;
      document.getElementById("joinPasswordInput").oninput = (e) => {
        const security = zxcvbn(e.target.value);
        passwordScore = security.score;
        document.getElementById("passwordSuggestion").textContent = security.feedback.suggestions;
        validatePassword();
      }

      document.getElementById("confirmJoinPasswordInput").oninput = (e) => {
        validatePassword();
      }

      function validatePassword() {
        if (passwordScore > 2 && document.getElementById("joinPasswordInput").value == document.getElementById("confirmJoinPasswordInput").value) {
          document.getElementById("downloadWallet").removeAttribute("disabled")
        } else {
          document.getElementById("downloadWallet").setAttribute("disabled", "")
        }
      }

      document.getElementById("downloadWallet").onclick = () => {
        const json = WalletManager.CreateNew(document.getElementById("joinPasswordInput").value);
        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json));
        var downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "novon_account.json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();

        const wallet = WalletManager.OpenExisting(document.getElementById("joinPasswordInput").value);
        new StreamApp(wallet);
      }
    };

  </script>

</body>

</html>